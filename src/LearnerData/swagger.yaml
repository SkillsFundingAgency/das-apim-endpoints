openapi: 3.0.0
info:
  version: '1.0'
  title: Learner data external API for consumption from an authenticated consumer
  description: 'This service will provide a contract to the Data Collections team for submission to the Apprenticeship service'
paths:
  /providers/{ukprn}/learners/{uln}:
    put:
      summary: External authenticated endpoint for updating specific learners. The individual key is combined by ukprn and uln
      security:
        - ApiKeyAuth: []  # Require API Key authentication
      parameters:
        - name: ukprn
          in: path
          required: true
          description: The UK Provider Reference Number for the provider entering this learner
          schema:
            type: string
        - name: uln
          in: path
          required: true
          description: The Unique Learner Number for this learner
          schema:
            type: string
      responses:
        '200':
          $ref: '#/components/responses/createUpdateResponse'
        '404':
          $ref: '#/components/responses/notFound'
        '401':
          $ref: '#/components/responses/unauthorized'
        '429':
          $ref: '#/components/responses/rateLimitExceededResponse'          
    post:
      summary: External authenticated endpoint for creating an ILR record
      security:
        - ApiKeyAuth: []  # Require API Key authentication
      parameters:
        - name: ukprn
          in: path
          required: true
          description: The UK Provider Reference Number for the provider entering this learner
          schema:
            type: string
        - name: uln
          in: path
          required: true
          description: The Unique Learner Number for this learner
          schema:
            type: string
      requestBody:
        $ref: '#/components/requestBodies/learnerRequest'
      responses:
        '201':
          $ref: '#/components/responses/createUpdateResponse'
        '400':
          $ref: '#/components/responses/badRequest'
        '401':
          $ref: '#/components/responses/unauthorized'
        '429':
          $ref: '#/components/responses/rateLimitExceededResponse'           
    get:
      summary: Returns the unique learner for this provider
      security:
        - ApiKeyAuth: []  # Require API Key authentication
      parameters:
        - name: ukprn
          in: path
          required: true
          description: The UK Provider Reference Number for the provider entering this learner
          schema:
            type: string
        - name: uln
          in: path
          required: true
          description: The Unique Learner Number for this learner
          schema:
            type: string
      responses:
        '200':
          $ref: '#/components/responses/learnerResponse'  
        '401':
          $ref: '#/components/responses/unauthorized'
        '404':
          $ref: '#/components/responses/notFound'
        '429':
          $ref: '#/components/responses/rateLimitExceededResponse'  
  /providers/{ukprn}/approved-candidates:
    get:
      summary: Returns a paged list of approved candidates for this provider
      security:
        - ApiKeyAuth: []  # Require API Key authentication
      parameters:
        - name: ukprn
          in: path
          required: true
          description: The UK Provider Reference Number for the provider entering this learner
          schema:
            type: string
      responses:
        '200':
          $ref: '#/components/responses/pagedApprovedCandidatesResponse'  
components:  
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: "Enter your API key in the `X-API-Key` header."
  headers:
    location:
      schema:
        type: string
        format: url
        example: /providers/234324/leaners/24321432
    X-RateLimit-Limit:
      description: The maximum number of requests allowed in a time window
      schema:
        type: integer
        example: 100
    X-RateLimit-Remaining:
      description: The number of requests remaining in the current time window
      schema:
        type: integer
        example: 99
    X-RateLimit-Reset:
      description: The time (in UNIX timestamp) when the rate limit resets
      schema:
        type: integer
        example: 1712345678
    Retry-After:
      description: The number of seconds to wait before making a new request
      schema:
        type: integer
        example: 60
  requestBodies:
    learnerRequest:
      description: The ilr record to be submitted to AS
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/learner'
  responses:
    pagedApprovedCandidatesResponse:
      description: A paged approved candidate response
      content:
        application/json:
          schema:
            type: array
            items:
              $ref: '#/components/schemas/pagedApprovedCandidate'
    createUpdateResponse:
      description: The update
      headers:
        Location:
          $ref: '#/components/headers/location'
        X-RateLimit-Limit:
          $ref: '#/components/headers/X-RateLimit-Limit'
        X-RateLimit-Remaining:
          $ref: '#/components/headers/X-RateLimit-Remaining'
        X-RateLimit-Reset:
          $ref: '#/components/headers/X-RateLimit-Reset'
    rateLimitExceededResponse:
      description: Too many requests - rate limit exceeded
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Rate limit exceeded. Try again later."
    learnerResponse:
      description: A single response to a specific learner
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/learner'
    notFound:
      description: The specified resource was not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error'
    badRequest:
      description: A bad request was detected
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error'
    unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error'
  schemas:
    error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
      required:
        - code
        - message
    pagedApprovedCandidate:
      type: object
      properties:
        learners:
          type: array
          items:
              $ref: '#/components/schemas/approvedCandidate'
        total:
          type: integer
          minimum: 0
        page: 
          type: integer
          minimum: 1
        pageSize: 
          type: integer
          minimum: 1
          maximum: 20
        totalPages: 
          type: integer
          minimum: 1
      required:
        - page
        - total
        - pageSize  
        - totalPages  
    approvedCandidate:
      type: object
      properties:
        uln:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        dateOfBirth:
          type: string
          format: date
        learnerEmail:
          type: string
          format: date
    learner:
      type: object
      properties:
        uln:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        dateOfBirth:
          type: string
          format: date
        learnerEmail:
          type: string
          format: date
        priorLearningValue:
          type: integer
        ukprn:
          type: string
        standardCode:
          type: string
        trainingPrice:
          type: integer
        epaoPrice:
          type: string
        startDate:
          type: string
          format: date
        plannedEndDate:
          type: string
          format: date
      required:
        - uln,
        - firstName
        - lastName
        - dateOfBirth
        - learnerEmail
        - ukprn
        - priorLearningValue
        - standardCode
        - trainingPrice
        - epaoPrice
        - startDate
        - plannedEndDate
security:
  - ApiKeyAuth: []  # Apply API Key security globally